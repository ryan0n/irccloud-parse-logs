#!/usr/bin/env php
<?php

namespace ryan0n\IrcCloudParseLogs;

use ryan0n\IrcCloudParseLogs\Model\ConfigModel;
use Exception;

require_once __DIR__ . '/../vendor/autoload.php';

try {
    // Process command line options
    $options = [];
    foreach ($argv as $arg) {
        if (preg_match_all("/^\-\-(.*?)\=(.*)$/", $arg, $matches)) {
            $options[$matches[1][0]] = $matches[2][0];
        }
    }
    $config = new ConfigModel($options);

    // First stage zip file validation
    if (empty($config->getZipFile())) {
        throw new Exception('No zip file given. ' . getUsage());
    }

    $objParser = new IrcCloudParseLogs($config);
    $objParser->run();

} catch (Exception $e) {
    echo "\n" . 'Error happened processing zip file: ' . $e->getMessage() . "\n\n";

}

/**
 * @return string
 */
function getUsage()
{
    return "\n\nUsage examples:\n"
        . "bin/parse --zipFile=./irccloud-export.zip --exportDriver=Json\n"
        . "bin/parse --zipFile=./irccloud-export.zip --exportDriver=GenericOutput\n"
        . "bin/parse --zipFile=./irccloud-export.zip --exportDriver=MySQL\n"
        . "bin/parse --zipFile=./irccloud-export.zip --exportDriver=GenericOutput --searchPhrase=trump\n\n";
}