#!/usr/bin/env php
<?php

namespace ryan0n\IrcCloudParseLogs;

use ryan0n\IrcCloudParseLogs\Exception\ {
    ExportDriverNotFoundException,
    UnparsableZipFileException
};
use ryan0n\IrcCloudParseLogs\Model\ConfigModel;
use Exception;

require_once __DIR__ . '/../vendor/autoload.php';

try {
    // Process command line options
    $options = [];
    foreach ($argv as $arg) {
        if (preg_match_all("/^\-\-(.*?)\=(.*)$/", $arg, $matches)) {
            $options[$matches[1][0]] = $matches[2][0];
        }
    }
    $config = new ConfigModel($options);

    // zip file validation
    if (null === $config->getZipFile()) {
        throw new UnparsableZipFileException('No zip file given.');
    }

    $objParser = new IrcCloudParseLogs($config);
    $objParser->run();

} catch (UnparsableZipFileException $e) {
    echo "\n" . 'Error occurred parsing zip file: ' . $e->getMessage() . "\n";
    echo getUsage();
} catch (ExportDriverNotFoundException $e) {
    echo "\n" . 'Error occurred initializing export driver: ' . $e->getMessage() . "\n";
    echo getUsage();
} catch (Exception $e) {
    echo "\n" . 'An unknown error occurred: ' . $e->getMessage() . "\n";
    echo getUsage();
}

/**
 * @return string
 */
function getUsage()
{
    return "\nUsage examples:\n"
        . "bin/parse --zipFile=./irccloud-export.zip --exportDriver=Json\n"
        . "bin/parse --zipFile=./irccloud-export.zip --exportDriver=GenericOutput\n"
        . "bin/parse --zipFile=./irccloud-export.zip --exportDriver=MySQL\n"
        . "bin/parse --zipFile=./irccloud-export.zip --exportDriver=GenericOutput --searchPhrase=trump\n";
}